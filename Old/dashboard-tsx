import { useQuery } from "@tanstack/react-query";
import { useEffect, useState } from "react";
import TopBar from "@/components/layout/top-bar";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Calendar, Filter } from "lucide-react";
import MetricCard from "@/components/dashboard/metric-card";
import LeadsTable from "@/components/dashboard/leads-table";
import ActivityFeed from "@/components/dashboard/activity-feed";
import QuickActions from "@/components/dashboard/quick-actions";
import PipelineOverview from "@/components/dashboard/pipeline-overview";
import { UserPlus, MessageSquare, Bot, DollarSign, TrendingUp, Target, Users, Clock, PieChart, BarChart3, Activity, Zap } from "lucide-react";

export default function Dashboard() {
  const [dateFilter, setDateFilter] = useState({
    startDate: '',
    endDate: ''
  });
  const [isFilterApplied, setIsFilterApplied] = useState(false);

  useEffect(() => {
    document.title = "Dashboard - CRM IA";
  }, []);

  const { data: metrics, isLoading: metricsLoading } = useQuery({
    queryKey: ["/api/dashboard/metrics", dateFilter],
    queryFn: async () => {
      const params = new URLSearchParams();
      if (dateFilter.startDate) params.append('startDate', dateFilter.startDate);
      if (dateFilter.endDate) params.append('endDate', dateFilter.endDate);
      
      const response = await fetch(`/api/dashboard/metrics?${params}`);
      if (!response.ok) throw new Error('Failed to fetch metrics');
      return response.json();
    }
  });

  const { data: leads, isLoading: leadsLoading } = useQuery({
    queryKey: ["/api/leads"],
  });

  const { data: interactions } = useQuery({
    queryKey: ["/api/interactions"],
  });

  // Type-safe metrics with defaults
  const safeMetrics = metrics as any || {};

  return (
    <div className="flex-1 flex flex-col overflow-hidden">
      <TopBar 
        title="Dashboard" 
        subtitle={new Date().toLocaleDateString('pt-BR', { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        })}
      />
      
      {/* Filtro por Data */}
      <div className="bg-white rounded-lg shadow-sm border p-4 mb-6 mx-6">
        <div className="flex items-center gap-4">
          <Calendar className="w-5 h-5 text-blue-600" />
          <Label className="font-medium">Filtrar por per√≠odo:</Label>
          <div className="flex items-center gap-2">
            <Input
              type="date"
              value={dateFilter.startDate}
              onChange={(e) => setDateFilter(prev => ({ ...prev, startDate: e.target.value }))}
              className="w-40"
              placeholder="Data inicial"
            />
            <span className="text-gray-500">at√©</span>
            <Input
              type="date"
              value={dateFilter.endDate}
              onChange={(e) => setDateFilter(prev => ({ ...prev, endDate: e.target.value }))}
              className="w-40"
              placeholder="Data final"
            />
            <Button 
              onClick={() => setIsFilterApplied(!isFilterApplied)}
              variant="outline"
              size="sm"
              className="flex items-center gap-2"
            >
              <Filter className="w-4 h-4" />
              Aplicar
            </Button>
            <Button 
              onClick={() => {
                setDateFilter({ startDate: '', endDate: '' });
                setIsFilterApplied(false);
              }}
              variant="ghost"
              size="sm"
            >
              Limpar
            </Button>
          </div>
        </div>
        {isFilterApplied && (dateFilter.startDate || dateFilter.endDate) && (
          <div className="mt-2 text-sm text-blue-600">
            üìä Filtro aplicado: {dateFilter.startDate ? new Date(dateFilter.startDate).toLocaleDateString('pt-BR') : 'In√≠cio'} 
            {' at√© '} 
            {dateFilter.endDate ? new Date(dateFilter.endDate).toLocaleDateString('pt-BR') : 'Hoje'}
          </div>
        )}
      </div>
      
      <main className="flex-1 overflow-y-auto p-6">
        {/* KPIs Principais */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <MetricCard
            title="Leads Este M√™s"
            value={metricsLoading ? "..." : (safeMetrics.leadsThisMonth?.toString() || "0")}
            change={metricsLoading ? "..." : `${safeMetrics.leadGrowth > 0 ? '+' : ''}${safeMetrics.leadGrowth || 0}% vs m√™s anterior`}
            changeType={safeMetrics.leadGrowth > 0 ? "positive" : safeMetrics.leadGrowth < 0 ? "negative" : "neutral"}
            icon={TrendingUp}
            iconColor="text-blue-600"
            iconBg="bg-blue-100"
          />
          
          <MetricCard
            title="Taxa de Convers√£o"
            value={metricsLoading ? "..." : `${safeMetrics.conversionRate || 0}%`}
            change="Meta: 15%"
            changeType={safeMetrics.conversionRate >= 15 ? "positive" : "negative"}
            icon={Target}
            iconColor="text-emerald-600"
            iconBg="bg-emerald-100"
          />
          
          <MetricCard
            title="Valor Pipeline"
            value={metricsLoading ? "..." : `R$ ${(safeMetrics.pipelineValue || 0).toLocaleString('pt-BR')}`}
            change="Oportunidades ativas"
            changeType="neutral"
            icon={PieChart}
            iconColor="text-purple-600"
            iconBg="bg-purple-100"
          />
          
          <MetricCard
            title="Ticket M√©dio"
            value={metricsLoading ? "..." : `R$ ${(safeMetrics.averageTicket || 0).toLocaleString('pt-BR')}`}
            change={`${safeMetrics.closedWonLeads || 0} vendas fechadas`}
            changeType="positive"
            icon={DollarSign}
            iconColor="text-amber-600"
            iconBg="bg-amber-100"
          />
        </div>

        {/* KPIs Secund√°rios */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <MetricCard
            title="Leads Hoje"
            value={metricsLoading ? "..." : (safeMetrics.leadsToday?.toString() || "0")}
            change="Capta√ß√£o di√°ria"
            changeType="neutral"
            icon={UserPlus}
            iconColor="text-indigo-600"
            iconBg="bg-indigo-100"
          />

          <MetricCard
            title="Taxa Qualifica√ß√£o"
            value={metricsLoading ? "..." : `${safeMetrics.qualificationRate || 0}%`}
            change={`${safeMetrics.qualifiedLeads || 0} de ${safeMetrics.totalLeads || 0} leads`}
            changeType={safeMetrics.qualificationRate >= 50 ? "positive" : "negative"}
            icon={Users}
            iconColor="text-cyan-600"
            iconBg="bg-cyan-100"
          />

          <MetricCard
            title="Atividades Semana"
            value={metricsLoading ? "..." : (safeMetrics.interactionsThisWeek?.toString() || "0")}
            change="Intera√ß√µes registradas"
            changeType="neutral"
            icon={Activity}
            iconColor="text-orange-600"
            iconBg="bg-orange-100"
          />

          <MetricCard
            title="Tempo Resposta"
            value={metricsLoading ? "..." : `${safeMetrics.responseTime || 0}h`}
            change="M√©dia de atendimento"
            changeType={safeMetrics.responseTime <= 2 ? "positive" : "negative"}
            icon={Clock}
            iconColor="text-rose-600"
            iconBg="bg-rose-100"
          />
        </div>

        {/* An√°lise do Funil de Vendas */}
        <div className="bg-white rounded-lg shadow-sm border p-6 mb-8">
          <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
            <BarChart3 className="w-5 h-5 text-blue-600" />
            Funil de Vendas
          </h3>
          
          {/* Funil Visual com Barras Progressivas */}
          <div className="space-y-4 mb-6">
            {[
              { name: 'Leads Totais', value: safeMetrics.totalLeads || 0, color: 'bg-gray-600', width: 100 },
              { name: 'Pendente', value: safeMetrics.leadsByStatus?.pendente || 0, color: 'bg-yellow-600', width: 85 },
              { name: 'Prospec√ß√£o', value: safeMetrics.leadsByStatus?.prospec√ß√£o || 0, color: 'bg-blue-600', width: 70 },
              { name: 'Proposta', value: safeMetrics.leadsByStatus?.proposta || 0, color: 'bg-purple-600', width: 50 },
              { name: 'Fechado', value: safeMetrics.leadsByStatus?.fechado || 0, color: 'bg-green-600', width: 25 }
            ].map((stage, index) => {
              const prevStage = index > 0 ? [
                { name: 'Leads Totais', value: safeMetrics.totalLeads || 0 },
                { name: 'Pendente', value: safeMetrics.leadsByStatus?.pendente || 0 },
                { name: 'Prospec√ß√£o', value: safeMetrics.leadsByStatus?.prospec√ß√£o || 0 },
                { name: 'Proposta', value: safeMetrics.leadsByStatus?.proposta || 0 },
                { name: 'Fechado', value: safeMetrics.leadsByStatus?.fechado || 0 }
              ][index - 1] : null;
              
              const conversionRate = prevStage && prevStage.value > 0 
                ? Math.round((stage.value / prevStage.value) * 100) 
                : 100;
              
              return (
                <div key={stage.name} className="relative">
                  {/* Barra do funil */}
                  <div className="relative bg-gray-100 rounded-lg overflow-hidden h-16 flex items-center">
                    <div 
                      className={`h-full ${stage.color} transition-all duration-1000 flex items-center justify-between px-6 rounded-lg`}
                      style={{ width: `${Math.max(stage.width, 15)}%` }}
                    >
                      <span className="text-white font-semibold">{stage.name}</span>
                      <div className="text-right">
                        <div className="text-white font-bold text-lg">{stage.value}</div>
                        {index > 0 && (
                          <div className="text-white/80 text-xs">{conversionRate}%</div>
                        )}
                      </div>
                    </div>
                  </div>
                  
                  {/* Seta conectora */}
                  {index < 4 && (
                    <div className="flex justify-center my-1">
                      <div className="w-0 h-0 border-l-4 border-r-4 border-t-6 border-transparent border-t-gray-400"></div>
                    </div>
                  )}
                </div>
              );
            })}
          </div>

          {/* M√©tricas de Performance */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 pt-4 border-t bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-4">
            <div className="text-center">
              <div className="text-2xl font-bold text-green-600">
                {safeMetrics.totalLeads > 0 ? Math.round((safeMetrics.closedWonLeads || 0) / safeMetrics.totalLeads * 100) : 0}%
              </div>
              <div className="text-sm text-gray-600">Convers√£o Geral</div>
            </div>
            <div className="text-center">
              <div className="text-2xl font-bold text-blue-600">
                R$ {safeMetrics.averageTicket ? Math.round(safeMetrics.averageTicket).toLocaleString('pt-BR') : '0'}
              </div>
              <div className="text-sm text-gray-600">Ticket M√©dio</div>
            </div>
            <div className="text-center">
              <div className="text-2xl font-bold text-purple-600">
                R$ {safeMetrics.pipelineValue ? Math.round(safeMetrics.pipelineValue).toLocaleString('pt-BR') : '0'}
              </div>
              <div className="text-sm text-gray-600">Valor Pipeline</div>
            </div>
          </div>
        </div>

        {/* Performance de Propostas */}
        <div className="bg-white rounded-lg shadow-sm border p-6 mb-8">
          <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
            üìä Performance de Propostas
          </h3>
          <div className="grid grid-cols-3 gap-8 mb-6">
            <div className="text-center">
              <div className="text-3xl font-bold text-blue-600">{safeMetrics.pendingProposals || 0}</div>
              <div className="text-sm text-gray-600 mt-1">Pendentes</div>
            </div>
            <div className="text-center">
              <div className="text-3xl font-bold text-green-600">{safeMetrics.approvedProposals || 0}</div>
              <div className="text-sm text-gray-600 mt-1">Aprovadas</div>
            </div>
            <div className="text-center">
              <div className="text-3xl font-bold text-red-600">{safeMetrics.rejectedProposals || 0}</div>
              <div className="text-sm text-gray-600 mt-1">Rejeitadas</div>
            </div>
          </div>
          
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <span className="text-sm font-medium text-gray-700">Taxa de Aprova√ß√£o: {safeMetrics.approvalRate || 0}%</span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-3">
              <div 
                className="bg-teal-600 h-3 rounded-full transition-all duration-500" 
                style={{ width: `${Math.min(safeMetrics.approvalRate || 0, 100)}%` }}
              ></div>
            </div>
          </div>
        </div>

        {/* Main Content Grid */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Leads Section */}
          <div className="lg:col-span-2">
            <LeadsTable leads={(leads as any) || []} isLoading={leadsLoading} />
          </div>

          {/* Right Sidebar */}
          <div className="space-y-6">
            <ActivityFeed interactions={(interactions as any) || []} />
            <QuickActions />
            {/* Pipeline overview removido */}
          </div>
        </div>
      </main>
    </div>
  );
}
